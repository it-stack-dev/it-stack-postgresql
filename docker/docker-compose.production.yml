# Lab 06 -- Production: PostgreSQL HA with streaming replication, PgBouncer, Prometheus exporter
---
x-pg-common: &pg-common
  image: bitnami/postgresql:16
  restart: always
  networks:
    - pg-prod-net

services:
  pg-primary:
    <<: *pg-common
    container_name: it-stack-pg-primary
    ports:
      - "5432:5432"
    environment:
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: replicator
      POSTGRESQL_REPLICATION_PASSWORD: "Lab06Password!"
      POSTGRESQL_USERNAME: labadmin
      POSTGRESQL_PASSWORD: "Lab06Password!"
      POSTGRESQL_DATABASE: labapp
      POSTGRESQL_POSTGRES_PASSWORD: "Lab06Password!"
    volumes:
      - pg-primary-data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U labadmin -d labapp"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G

  pg-replica:
    <<: *pg-common
    container_name: it-stack-pg-replica
    ports:
      - "5433:5432"
    environment:
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_MASTER_HOST: pg-primary
      POSTGRESQL_MASTER_PORT_NUMBER: 5432
      POSTGRESQL_REPLICATION_USER: replicator
      POSTGRESQL_REPLICATION_PASSWORD: "Lab06Password!"
      POSTGRESQL_USERNAME: labadmin
      POSTGRESQL_PASSWORD: "Lab06Password!"
      POSTGRESQL_POSTGRES_PASSWORD: "Lab06Password!"
    volumes:
      - pg-replica-data:/bitnami/postgresql
    depends_on:
      pg-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U labadmin"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G

  pgbouncer:
    image: bitnami/pgbouncer:1
    container_name: it-stack-pgbouncer
    ports:
      - "6432:6432"
    environment:
      POSTGRESQL_HOST: pg-primary
      POSTGRESQL_PORT: 5432
      POSTGRESQL_DATABASE: labapp
      POSTGRESQL_USERNAME: labadmin
      POSTGRESQL_PASSWORD: "Lab06Password!"
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 200
      PGBOUNCER_DEFAULT_POOL_SIZE: 20
      PGBOUNCER_AUTH_TYPE: scram-sha-256
    depends_on:
      pg-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432 -U labadmin"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - pg-prod-net
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: it-stack-postgres-exporter
    ports:
      - "9187:9187"
    environment:
      DATA_SOURCE_NAME: "postgresql://labadmin:Lab06Password!@pg-primary:5432/labapp?sslmode=disable"
      PG_EXPORTER_DISABLE_SETTINGS_METRICS: "false"
      PG_EXPORTER_AUTO_DISCOVER_DATABASES: "true"
    depends_on:
      pg-primary:
        condition: service_healthy
    networks:
      - pg-prod-net
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

networks:
  pg-prod-net:
    driver: bridge

volumes:
  pg-primary-data:
  pg-replica-data:
